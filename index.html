<!doctype html>
<html lang="en">
<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-17602095-33"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'UA-17602095-33');
  </script>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>mail to line</title>
  <link rel="shortcut icon" href="favicon-194x194.png">
  <link rel="stylesheet" href="main.css">
</head>
<body>
  <main>
    <h1>mail to line</h1>
    <form name="form" id="id_form" action="">
      <input id="form" type="text" name="form" style="width: 200px;" value="LINE Tokenを入力してください"></input>
    </form>
    <button id="install-button">Install</button>
    <pre id="content"></pre>
  </main>

  <script type="text/javascript">
    var CLIENT_ID = '75405879646-52b4b1vpafl8mnuenkg3vmo7cel57ovi.apps.googleusercontent.com';
    var API_KEY = 'AIzaSyBg9Z82ufL_3uoz8FWHA8ZS8sHnW4SCeCw';
    var DISCOVERY_DOCS = ["https://script.googleapis.com/$discovery/rest?version=v1"];
    var SCOPES = [
      'https://www.googleapis.com/auth/script.projects',
      'https://www.googleapis.com/auth/script.deployments'
    ].join(' ');

    var installButton = document.getElementById('install-button');

    /**
     *  On load, called to load the auth2 library and API client library.
     */
    function handleClientLoad() {
      gapi.load('client:auth2', initClient);
    }

    /**
     *  Initializes the API client library and sets up sign-in state
     *  listeners.
     */
    function initClient() {
      gapi.client.init({
        apiKey: API_KEY,
        clientId: CLIENT_ID,
        discoveryDocs: DISCOVERY_DOCS,
        scope: SCOPES
      }).then(function () {
        installButton.onclick = handleButtonClick;
      });
    }

    function updateInstallStatus() {
      installButton.className = 'disabled';
      installButton.textContent = 'Installing...';
    }

    /**
     *  Sign in the user upon button click.
     */
    function handleButtonClick(event) {
      if (gapi.auth2.getAuthInstance().isSignedIn.get()) {
        updateInstallStatus();
        install();
        return;
      }
      gapi.auth2.getAuthInstance().signIn().then(() => {
        updateInstallStatus();
        install();
      });
    }

    /**
     * Append a pre element to the body containing the given message
     * as its text node. Used to display the results of the API call.
     *
     * @param {string} message Text to be placed in pre element.
     */
    function appendPre(message, status) {
      var pre = document.getElementById('content');
      var span = document.createElement('span');
      span.textContent = message + ' ';
      if (status) {
        span.className = status >= 200 && status < 300 ? 'success' : 'danger';
      }
      pre.appendChild(span);
    }

    function install() {
      let project;
      appendPre('Please wait');
      getJSON('konjac-api.json').then(data => {
        project = data;
        return gapi.client.script.projects.create({
          resource: {
            title: 'konjac-api'
          }
        });
      }).then(res => {
        appendPre('.');
        return gapi.client.script.projects.updateContent({
          scriptId: res.result.scriptId,
          resource: project
        });
      }).then(res => {
        appendPre('.');
        return gapi.client.script.projects.versions.create({
          scriptId: res.result.scriptId,
          resource: {
            versionNumber: 1
          }
        });
      }).then(res => {
        appendPre('.');
        return gapi.client.script.projects.deployments.create({
          scriptId: res.result.scriptId,
          resource: {
            versionNumber: 1
          }
        });
      }).then(res => {
        appendPre('Successfully installed', res.status);
      }).catch((e) => {
        error = e.result && e.result.error ? e.result.error : e;
        appendPre(error.message, error.status);
        console.error(error);
      });
    }

    function getJSON(url) {
      return new Promise((resolve, reject) => {
        if (true) {
          console.log(createJson(document.forms.form.form.value));
          resolve(JSON.parse(createJson(document.forms.form.form.value)));
        } else {
          reject();
        }
      });
    }
    function createJson(str) {
      var prex = '{"files":[{"name":"コード","type":"server_js","source":"var lineToken \u003d \"';
      var sufx = '\";\nvar get_interval \u003d 1;\n\nfunction send_line(Me){\n  var payload \u003d {\u0027message\u0027 : Me};\n  var options \u003d{\n        \"method\"  : \"post\",\n        \"payload\" : payload,\n        \"headers\" : {\"Authorization\" : \"Bearer \"+ lineToken}  \n      };\n    UrlFetchApp.fetch(\"https://notify-api.line.me/api/notify\", options);\n}\n\n\nfunction fetchContactMail() {\n  //取得間隔\n  var now_time\u003d Math.floor(new Date().getTime() / 1000) ;//現在時刻を変換\n  var time_term \u003d now_time - (60 * get_interval); //変換\n\n  //検索条件指定\n  var strTerms \u003d \u0027(is:unread after:\u0027+ time_term + \u0027)\u0027;\n\n  //取得\n  var myThreads \u003d GmailApp.search(strTerms);\n  var myMsgs \u003d GmailApp.getMessagesForThreads(myThreads);\n  var valMsgs \u003d [];\n  for(var i \u003d 0; i \u003c myMsgs.length;i++){\n    valMsgs[i] \u003d myMsgs[i][0].getPlainBody().replace(/\\r?\\n/g, \u0027\u0027);\n  //  myMsgs[i].markRead(); //メッセージを既読にする\n  }\n\n  return valMsgs;\n\n}\n\nfunction main() {\n  //send_line(\"tetete!\")\n  new_Me \u003d fetchContactMail()\n  if(new_Me.length \u003e 0){\n    for(var i \u003d new_Me.length-1; i \u003e\u003d 0; i--){\n      send_line(new_Me[i])\n    }\n  }\n}\n\n"},{"name":"appsscript","type":"json","source":"{\n  \"timeZone\": \"Asia/Tokyo\",\n  \"dependencies\": {\n  },\n  \"exceptionLogging\": \"STACKDRIVER\"\n}"}]}';
      return prex + str + sufx;
    }
  </script>
  <script async defer
    src="https://apis.google.com/js/api.js"
    onload="this.onload=function(){};handleClientLoad()"
    onreadystatechange="if (this.readyState === 'complete') this.onload()"></script>
</body>
</html>
